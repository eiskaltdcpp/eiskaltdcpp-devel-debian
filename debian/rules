#!/usr/bin/make -f

PACKAGE = eiskaltdcpp

DEBIAN_PATH := $(abspath $(dir $(MAKEFILE_LIST)))
USCAN_REPORT = $(shell uscan --noconf --report --dehs "$(DEBIAN_PATH)")
CUR_VER = $(shell echo "$(USCAN_REPORT)" | sed -n 's/.*<upstream-version>\(.*\)<\/upstream-version>.*/\1/p')
CUR_URL = $(shell echo "$(USCAN_REPORT)" | sed -n 's/.*<upstream-url>\(.*\)<\/upstream-url>.*/\1/p')

export DEB_CXXFLAGS_MAINT_APPEND = $(shell dpkg-buildflags --get CPPFLAGS)
export DEB_LDFLAGS_MAINT_APPEND = -Wl,--as-needed
export DEB_BUILD_MAINT_OPTIONS = hardening=+all

CMAKEOPTS = -DUSE_MINIUPNP=ON \
            -DLOCAL_MINIUPNP=OFF \
            -DLUA_SCRIPT=ON \
            -DWITH_LUASCRIPTS=ON \
            -DPERL_REGEX=ON \
            -DWITH_DHT=ON \
            -DUSE_IDNA=ON \
            -DWITH_SOUNDS=ON \
            -DUSE_QT=ON \
            -DUSE_QT_SQLITE=ON \
            -DUSE_JS=ON \
            -DUSE_QT_QML=ON \
            -DUSE_ASPELL=ON \
            -DFREE_SPACE_BAR_C=ON \
            -DUSE_GTK=ON \
            -DUSE_GTK3=OFF \
            -DCHECK_GTK_DEPRECATED=OFF \
            -DUSE_LIBGNOME2=OFF \
            -DUSE_LIBNOTIFY=ON \
            -DCREATE_MO=ON \
            -DUPDATE_PO=OFF \
            -DNO_UI_DAEMON=ON \
            -DXMLRPC_DAEMON=OFF \
            -DJSONRPC_DAEMON=ON \
            -DUSE_CLI_JSONRPC=ON \
            -DWITH_DEV_FILES=ON


# This option is for daily builds of the EiskaltDC++ packages on Launchpad
# See https://launchpad.net/~tehnick/+archive/tehnick for more information
REVISION = $(shell /bin/sh -c "head -n 1 debian/changelog | sed -e 's/^.*-[0-9]\+-g\(.*\)-0ppa.*$/\1/'")
CMAKEOPTS += -DDCPP_REVISION="$(REVISION)"


%:
	dh $@ --buildsystem=cmake --parallel --list-missing

override_dh_auto_configure:
	dh_auto_configure -- $(CMAKEOPTS)

# override_dh_auto_clean:
# 	dh_testroot
# 	[ ! -f Makefile ] || ( cd $(BUILDDIR1) && $(MAKE) clean )
# 	[ ! -f Makefile ] || ( cd $(BUILDDIR2) && $(MAKE) clean )
# 	[ ! -d $(BUILDDIR1) ] || rm -r $(BUILDDIR1)
# 	[ ! -d $(BUILDDIR2) ] || rm -r $(BUILDDIR2)
# 	rm -f configure-stamp build-stamp

# override_dh_installchangelogs:
# 	dh_installchangelogs ChangeLog.txt

# .PHONY: override_dh_makeshlibs
# override_dh_makeshlibs:
# 	dh_makeshlibs -V -plibeiskaltdcpp2.3

# .PHONY: override_dh_shlibdeps
# override_dh_shlibdeps:
# 	dh_shlibdeps -a -ldebian/libeiskaltdcpp2.3/usr/lib

get-orig-source:
	wget -c "$(CUR_URL)" -O "$(PACKAGE)_$(CUR_VER).orig.tar.xz"
